// SPDX-License-Identifier: MIT
pragma solidity ^0.8.25;

import {Test, console} from "forge-std/Test.sol";
import "../src/ZKNOX_NTT.sol";
import "../src/ZKNOX_NTT_falcon.sol";

contract NTTTest is Test {
    //exemple of stateless initialisation, no external contract provided
    ZKNOX_NTT ntt = new ZKNOX_NTT(address(0), address(0), 12289, 12265);
    // forgefmt: disable-next-line
    uint256[512] psi_rev = [uint256(1), 10810, 7143, 4043, 10984, 722, 5736, 8155, 3542, 8785, 9744, 3621, 10643, 1212, 3195, 5860, 7468, 2639, 9664, 11340, 11726, 9314, 9283, 9545, 5728, 7698, 5023, 5828, 8961, 6512, 7311, 1351, 2319, 11119, 11334, 11499, 9088, 3014, 5086, 10963, 4846, 9542, 9154, 3712, 4805, 8736, 11227, 9995, 3091, 12208, 7969, 11289, 9326, 7393, 9238, 2366, 11112, 8034, 10654, 9521, 12149, 10436, 7678, 11563, 1260, 4388, 4632, 6534, 2426, 334, 1428, 1696, 2013, 9000, 729, 3241, 2881, 3284, 7197, 10200, 8595, 7110, 10530, 8582, 3382, 11934, 9741, 8058, 3637, 3459, 145, 6747, 9558, 8357, 7399, 6378, 9447, 480, 1022, 9, 9821, 339, 5791, 544, 10616, 4278, 6958, 7300, 8112, 8705, 1381, 9764, 11336, 8541, 827, 5767, 2476, 118, 2197, 7222, 3949, 8993, 4452, 2396, 7935, 130, 2837, 6915, 2401, 442, 7188, 11222, 390, 773, 8456, 3778, 354, 4861, 9377, 5698, 5012, 9808, 2859, 11244, 1017, 7404, 1632, 7205, 27, 9223, 8526, 10849, 1537, 242, 4714, 8146, 9611, 3704, 5019, 11744, 1002, 5011, 5088, 8005, 7313, 10682, 8509, 11414, 9852, 3646, 6022, 2987, 9723, 10102, 6250, 9867, 11224, 2143, 11885, 7644, 1168, 5277, 11082, 3248, 493, 8193, 6845, 2381, 7952, 11854, 1378, 1912, 2166, 3915, 12176, 7370, 12129, 3149, 12286, 4437, 3636, 4938, 5291, 2704, 10863, 7635, 1663, 10512, 3364, 1689, 4057, 9018, 9442, 7875, 2174, 4372, 7247, 9984, 4053, 2645, 5195, 9509, 7394, 1484, 9042, 9603, 8311, 9320, 9919, 2865, 5332, 3510, 1630, 10163, 5407, 3186, 11136, 9405, 10040, 8241, 9890, 8889, 7098, 9153, 9289, 671, 3016, 243, 6730, 420, 10111, 1544, 3985, 4905, 3531, 476, 49, 1263, 5915, 1483, 9789, 10800, 10706, 6347, 1512, 350, 10474, 5383, 5369, 10232, 9087, 4493, 9551, 6421, 6554, 2655, 9280, 1693, 174, 723, 10314, 8532, 347, 2925, 8974, 11863, 1858, 4754, 3030, 4115, 2361, 10446, 2908, 218, 3434, 8760, 3963, 576, 6142, 9842, 1954, 10238, 9407, 10484, 3991, 8320, 9522, 156, 2281, 5876, 10258, 5333, 3772, 418, 5908, 11836, 5429, 7515, 7552, 1293, 295, 6099, 5766, 652, 8273, 4077, 8527, 9370, 325, 10885, 11143, 11341, 5990, 1159, 8561, 8240, 3329, 4298, 12121, 2692, 5961, 7183, 10327, 1594, 6167, 9734, 7105, 11089, 1360, 3956, 6170, 5297, 8210, 11231, 922, 441, 1958, 4322, 1112, 2078, 4046, 709, 9139, 1319, 4240, 8719, 6224, 11454, 2459, 683, 3656, 12225, 10723, 5782, 9341, 9786, 9166, 10542, 9235, 6803, 7856, 6370, 3834, 7032, 7048, 9369, 8120, 9162, 6821, 1010, 8807, 787, 5057, 4698, 4780, 8844, 12097, 1321, 4912, 10240, 677, 6415, 6234, 8953, 1323, 9523, 12237, 3174, 1579, 11858, 9784, 5906, 3957, 9450, 151, 10162, 12231, 12048, 3532, 11286, 1956, 7280, 11404, 6281, 3477, 6608, 142, 11184, 9445, 3438, 11314, 4212, 9260, 6695, 4782, 5886, 8076, 504, 2302, 11684, 11868, 8209, 3602, 6068, 8689, 3263, 6077, 7665, 7822, 7500, 6752, 4749, 4449, 6833, 12142, 8500, 6118, 8471, 1190, 9606, 3860, 5445, 7753, 11239, 5079, 9027, 2169, 11767, 7965, 4916, 8214, 5315, 11011, 9945, 1973, 6715, 8775, 11248, 5925, 11271, 654, 3565, 1702, 1987, 6760, 5206, 3199, 12233, 6136, 6427, 6874, 8646, 4948, 6152, 400, 10561, 5339, 5446, 3710, 6093, 468, 8301, 316, 11907, 10256, 8291, 3879, 1922, 10930, 6854, 973, 11035];

    // forgefmt: disable-next-line
    uint256[512] psi_inv_rev = [uint256(1), 1479, 8246, 5146, 4134, 6553, 11567, 1305, 6429, 9094, 11077, 1646, 8668, 2545, 3504, 8747, 10938, 4978, 5777, 3328, 6461, 7266, 4591, 6561, 2744, 3006, 2975, 563, 949, 2625, 9650, 4821, 726, 4611, 1853, 140, 2768, 1635, 4255, 1177, 9923, 3051, 4896, 2963, 1000, 4320, 81, 9198, 2294, 1062, 3553, 7484, 8577, 3135, 2747, 7443, 1326, 7203, 9275, 3201, 790, 955, 1170, 9970, 5374, 9452, 12159, 4354, 9893, 7837, 3296, 8340, 5067, 10092, 12171, 9813, 6522, 11462, 3748, 953, 2525, 10908, 3584, 4177, 4989, 5331, 8011, 1673, 11745, 6498, 11950, 2468, 12280, 11267, 11809, 2842, 5911, 4890, 3932, 2731, 5542, 12144, 8830, 8652, 4231, 2548, 355, 8907, 3707, 1759, 5179, 3694, 2089, 5092, 9005, 9408, 9048, 11560, 3289, 10276, 10593, 10861, 11955, 9863, 5755, 7657, 7901, 11029, 11813, 8758, 7384, 8304, 10745, 2178, 11869, 5559, 12046, 9273, 11618, 3000, 3136, 5191, 3400, 2399, 4048, 2249, 2884, 1153, 9103, 6882, 2126, 10659, 8779, 6957, 9424, 2370, 2969, 3978, 2686, 3247, 10805, 4895, 2780, 7094, 9644, 8236, 2305, 5042, 7917, 10115, 4414, 2847, 3271, 8232, 10600, 8925, 1777, 10626, 4654, 1426, 9585, 6998, 7351, 8653, 7852, 3, 9140, 160, 4919, 113, 8374, 10123, 10377, 10911, 435, 4337, 9908, 5444, 4096, 11796, 9041, 1207, 7012, 11121, 4645, 404, 10146, 1065, 2422, 6039, 2187, 2566, 9302, 6267, 8643, 2437, 875, 3780, 1607, 4976, 4284, 7201, 7278, 11287, 545, 7270, 8585, 2678, 4143, 7575, 12047, 10752, 1440, 3763, 3066, 12262, 5084, 10657, 4885, 11272, 1045, 9430, 2481, 7277, 6591, 2912, 7428, 11935, 8511, 3833, 11516, 11899, 1067, 5101, 11847, 9888, 1254, 11316, 5435, 1359, 10367, 8410, 3998, 2033, 382, 11973, 3988, 11821, 6196, 8579, 6843, 6950, 1728, 11889, 6137, 7341, 3643, 5415, 5862, 6153, 56, 9090, 7083, 5529, 10302, 10587, 8724, 11635, 1018, 6364, 1041, 3514, 5574, 10316, 2344, 1278, 6974, 4075, 7373, 4324, 522, 10120, 3262, 7210, 1050, 4536, 6844, 8429, 2683, 11099, 3818, 6171, 3789, 147, 5456, 7840, 7540, 5537, 4789, 4467, 4624, 6212, 9026, 3600, 6221, 8687, 4080, 421, 605, 9987, 11785, 4213, 6403, 7507, 5594, 3029, 8077, 975, 8851, 2844, 1105, 12147, 5681, 8812, 6008, 885, 5009, 10333, 1003, 8757, 241, 58, 2127, 12138, 2839, 8332, 6383, 2505, 431, 10710, 9115, 52, 2766, 10966, 3336, 6055, 5874, 11612, 2049, 7377, 10968, 192, 3445, 7509, 7591, 7232, 11502, 3482, 11279, 5468, 3127, 4169, 2920, 5241, 5257, 8455, 5919, 4433, 5486, 3054, 1747, 3123, 2503, 2948, 6507, 1566, 64, 8633, 11606, 9830, 835, 6065, 3570, 8049, 10970, 3150, 11580, 8243, 10211, 11177, 7967, 10331, 11848, 11367, 1058, 4079, 6992, 6119, 8333, 10929, 1200, 5184, 2555, 6122, 10695, 1962, 5106, 6328, 9597, 168, 7991, 8960, 4049, 3728, 11130, 6299, 948, 1146, 1404, 11964, 2919, 3762, 8212, 4016, 11637, 6523, 6190, 11994, 10996, 4737, 4774, 6860, 453, 6381, 11871, 8517, 6956, 2031, 6413, 10008, 12133, 2767, 3969, 8298, 1805, 2882, 2051, 10335, 2447, 6147, 11713, 8326, 3529, 8855, 12071, 9381, 1843, 9928, 8174, 9259, 7535, 10431, 426, 3315, 9364, 11942, 3757, 1975, 11566, 12115, 10596, 3009, 9634, 5735, 5868, 2738, 7796, 3202, 2057, 6920, 6906, 1815, 11939, 10777, 5942, 1583, 1489, 2500, 10806, 6374, 11026, 12240];

    uint256 constant q = 12289; //falcon field
    uint256 nm1modq = 12265; //512^-1 mod 12289

    //Test vector generated by pythonref
    // q = 12289
    // n = 512
    // forgefmt: disable-next-line
	uint256[]  f_12289_512 = [9999, 7085, 6820, 8778, 6376, 3654, 751, 8032, 9000, 7804, 1199, 698, 11321, 9441, 11590, 1244, 4515, 10616, 6860, 441, 6800, 11579, 4591, 5953, 10392, 4264, 2672, 10279, 1124, 2490, 3242, 6344, 5052, 1585, 4677, 3186, 4500, 6989, 439, 2822, 12191, 8937, 1146, 10412, 9422, 8183, 6233, 12110, 10972, 7139, 4359, 5441, 171, 7485, 579, 7478, 8148, 523, 8046, 11529, 5261, 11343, 478, 11537, 8707, 1510, 4800, 3705, 6474, 8752, 10907, 5380, 2680, 2901, 8837, 174, 7393, 11327, 3000, 2962, 10762, 7159, 8732, 7335, 11165, 6400, 12254, 437, 7048, 763, 4495, 1246, 6650, 5548, 3303, 2931, 4471, 5342, 1372, 3210, 11499, 8447, 2992, 1331, 9795, 4331, 11998, 10437, 256, 8575, 3680, 8881, 11551, 8194, 5884, 8706, 209, 6116, 8410, 1267, 12001, 12014, 3395, 10985, 9744, 4718, 2837, 253, 5994, 10098, 1209, 1776, 3579, 11570, 3584, 8590, 2377, 5086, 6065, 4455, 8477, 11240, 1822, 3409, 8505, 210, 753, 11201, 5575, 8074, 5896, 4296, 186, 9500, 1067, 7082, 373, 6179, 2421, 3628, 8590, 11689, 6489, 6551, 8331, 10160, 1585, 8286, 799, 10449, 8457, 11846, 5133, 10416, 11189, 8187, 8623, 10356, 11588, 2870, 5605, 6259, 1407, 2593, 6225, 7484, 9443, 6445, 3625, 9208, 2332, 431, 11337, 9534, 6147, 5040, 545, 11742, 6332, 6725, 6040, 3370, 7499, 4852, 2916, 808, 9664, 10995, 10026, 12143, 8422, 2811, 3387, 10, 2568, 5567, 7382, 2162, 8864, 11244, 3273, 6476, 4174, 12066, 2462, 1188, 4064, 4948, 4334, 3219, 9572, 9314, 672, 4486, 9624, 4458, 11150, 804, 7908, 1939, 6524, 3338, 4090, 11839, 3566, 4053, 5510, 1824, 3590, 4512, 7475, 6840, 6576, 3581, 4794, 1295, 5474, 7370, 10342, 11576, 6954, 9507, 6341, 7708, 8462, 623, 10455, 1541, 1594, 3792, 8428, 5141, 6225, 7364, 11122, 6508, 2612, 11177, 5824, 2083, 6083, 11117, 11272, 3482, 1941, 9261, 11511, 1737, 11921, 8655, 11129, 8438, 4302, 3417, 5024, 11466, 11899, 9353, 7791, 9025, 7296, 4018, 10424, 7731, 11727, 6659, 2313, 8413, 683, 65, 2686, 4672, 9454, 329, 8409, 4128, 6098, 8959, 483, 8285, 7679, 8206, 11528, 830, 9903, 4553, 1983, 2615, 5720, 7285, 5117, 11315, 6235, 9229, 5817, 8071, 8875, 7024, 8567, 6100, 10668, 205, 7304, 281, 12242, 9947, 1653, 9104, 3412, 6728, 4368, 1804, 6962, 10170, 7739, 3254, 10975, 12197, 1218, 1816, 5613, 313, 7621, 594, 5447, 12164, 8562, 10386, 6368, 9309, 8303, 7136, 7366, 5550, 8623, 4376, 6385, 4930, 3184, 10000, 8112, 8324, 3566, 6386, 10547, 108, 95, 3433, 757, 2675, 8604, 7700, 3169, 4135, 272, 10108, 3674, 4476, 3684, 2662, 12105, 4869, 4321, 10208, 5599, 4868, 9853, 7446, 7440, 4281, 7633, 10743, 5528, 11175, 1841, 1030, 6640, 3909, 274, 1231, 2112, 5318, 8734, 9417, 10719, 10515, 10507, 151, 9255, 5479, 7751, 9110, 10075, 712, 6244, 2837, 6071, 3809, 12200, 6716, 5507, 10742, 5016, 2999, 5379, 8065, 4024, 10958, 8328, 5454, 10131, 6814, 5121, 4739, 132, 11121, 6487, 8948, 3515, 8429, 3096, 3514, 11468, 7402, 3186, 7126, 6968, 9720, 6853, 8190, 7780, 7266, 3759, 6383, 3490, 1828, 4248, 5327, 4740, 9462, 8450, 10998, 6238, 11283, 6074, 8314, 11629, 11905, 10089, 12099, 3489, 2352, 8721, 416, 8068, 8319, 213, 5593, 4978, 2617, 3447, 11486, 5677, 10457, 4227, 209, 6519, 639, 5568, 7873, 11843, 11108];
    // forgefmt: disable-next-line
	uint256[]  g_12289_512 = [7496, 2854, 12210, 4565, 6937, 6826, 8201, 149, 9145, 1435, 3905, 5913, 1035, 1168, 10352, 5416, 2759, 10446, 9365, 4349, 10642, 5915, 11360, 2083, 1602, 4923, 4862, 2070, 7632, 9689, 4544, 5381, 2044, 8317, 1734, 8506, 10964, 8327, 5827, 4428, 5257, 4088, 4518, 3645, 11165, 11867, 433, 12190, 4986, 5870, 657, 10985, 2709, 1598, 6317, 3552, 6448, 7560, 1714, 12268, 5063, 2962, 11831, 12160, 5077, 8450, 7040, 2692, 1527, 3938, 12130, 3856, 3433, 8728, 9274, 2027, 4224, 493, 7556, 10342, 3649, 1030, 9284, 1383, 4578, 4134, 8276, 114, 2090, 7860, 1513, 5945, 3220, 2418, 4523, 10114, 6751, 6983, 4655, 9411, 4362, 4080, 10593, 1439, 11804, 2799, 3533, 6366, 1800, 9403, 122, 7838, 4937, 10546, 4422, 2956, 3072, 1669, 151, 6980, 9962, 1514, 812, 1538, 7587, 9843, 4060, 9228, 1558, 1635, 2750, 7608, 11415, 11584, 7287, 7345, 4270, 8224, 4800, 7112, 11652, 8585, 9770, 11314, 8805, 8437, 1135, 10787, 4379, 4569, 9748, 4767, 1467, 1750, 5023, 3987, 6525, 9960, 7730, 3178, 3440, 8859, 11599, 8262, 6554, 9045, 7764, 5119, 4383, 6964, 1488, 10619, 3450, 11163, 11885, 6212, 12103, 951, 7025, 4535, 3759, 4366, 9511, 6452, 943, 3708, 6938, 10805, 5815, 8485, 9730, 5276, 11049, 5437, 12141, 2160, 7617, 5119, 3592, 6376, 6556, 382, 7246, 2168, 11138, 8168, 8188, 3137, 4618, 1017, 749, 1810, 3996, 1785, 2290, 4415, 3500, 9990, 4976, 5104, 11515, 6444, 9086, 9092, 9165, 11066, 10920, 2101, 5436, 11590, 3215, 1167, 759, 11359, 4679, 12036, 6836, 2788, 5467, 277, 860, 10540, 9349, 299, 7890, 4069, 7561, 9450, 9185, 12095, 6956, 4049, 4627, 3889, 8827, 6825, 4224, 5740, 3852, 3446, 2662, 3479, 10485, 2197, 2523, 6803, 466, 4796, 4612, 871, 6102, 3684, 3411, 3455, 10082, 5682, 10778, 1002, 17, 4815, 8842, 4933, 1400, 3591, 5024, 6705, 11868, 4749, 327, 10862, 11266, 4912, 3620, 2312, 2877, 10147, 5874, 6176, 7145, 437, 7753, 6695, 3734, 964, 8305, 9903, 7892, 5828, 7992, 8233, 7042, 8858, 12066, 1936, 3849, 5221, 384, 7233, 3711, 10479, 7452, 919, 12145, 452, 3787, 7108, 212, 2135, 11687, 3462, 11016, 6090, 5724, 3092, 10324, 5556, 2523, 4236, 5468, 3833, 8283, 495, 10103, 10450, 6143, 8231, 9899, 443, 6882, 5337, 1607, 11791, 8825, 5775, 10086, 663, 2617, 2596, 1509, 1330, 9600, 5033, 7226, 6961, 9868, 1092, 8566, 9000, 6464, 11374, 1968, 1854, 3478, 2663, 5645, 6742, 5591, 7121, 497, 3096, 6762, 6037, 1625, 11277, 4412, 8979, 4670, 11322, 3663, 10760, 640, 7431, 5628, 7565, 8317, 3852, 4593, 10350, 10091, 7766, 10718, 7483, 12103, 6449, 10529, 9928, 9657, 10570, 2027, 9689, 3667, 809, 723, 192, 6466, 4006, 9356, 6573, 1508, 10454, 1014, 6857, 7056, 4805, 12240, 3744, 2622, 5373, 10060, 717, 11826, 9430, 7885, 9814, 680, 298, 8297, 5171, 7032, 6666, 8658, 10725, 3166, 6534, 10874, 7561, 8201, 4533, 7381, 1937, 6472, 11498, 1017, 6460, 3570, 10772, 1734, 4547, 10464, 2388, 6757, 1955, 12169, 6034, 2204, 4909, 783, 2394, 10330, 5589, 5399, 5905, 2513, 8888, 3771, 6477, 11145, 8640, 10521, 5372, 9825, 11247, 6504, 7, 5065, 2514, 8678, 8894, 3370, 11302, 2681, 9618, 6961, 8416, 4161, 6781, 4405, 6280, 2072, 6008, 10910, 4233, 11606, 2989, 5563, 3249, 10505, 3029, 7639, 11973, 6372, 1411];
    // forgefmt: disable-next-line
	uint256[]  f_ntt_12289_512 = [4532, 2031, 7642, 7164, 3184, 12211, 4904, 5413, 97, 10932, 158, 8709, 565, 5022, 343, 2736, 10091, 9037, 8601, 4539, 5177, 10969, 11280, 158, 6802, 9140, 10096, 1387, 7606, 7181, 3699, 6404, 4046, 3524, 2309, 7325, 2799, 7022, 5550, 3283, 10234, 12103, 2821, 4692, 4804, 8194, 5977, 7374, 6625, 6438, 7350, 4833, 8778, 8122, 421, 2914, 3888, 6987, 10558, 3325, 3071, 2957, 730, 1208, 9855, 10973, 7036, 7524, 10808, 5891, 8336, 12049, 12005, 11287, 359, 2153, 1182, 4339, 4676, 5242, 7173, 2592, 7442, 7034, 7490, 10096, 6423, 12157, 704, 6016, 10913, 6403, 6374, 6496, 12123, 5620, 4359, 8747, 8823, 7217, 5593, 3444, 11127, 9110, 12041, 974, 11145, 10887, 9930, 9955, 3851, 782, 8237, 3722, 175, 5077, 9744, 8157, 9065, 1880, 2984, 6795, 8523, 8120, 5442, 9136, 6865, 4141, 1758, 5627, 9313, 2454, 10194, 905, 7321, 1184, 11746, 8906, 11411, 9369, 4513, 2731, 9616, 5014, 11347, 3341, 4956, 7220, 10904, 3658, 2151, 7892, 5458, 11070, 5399, 8991, 11400, 12081, 8620, 9292, 9540, 9968, 8686, 8896, 1721, 10759, 3261, 5522, 5250, 6435, 6001, 5365, 3761, 10672, 1235, 4299, 3028, 10687, 5273, 9647, 2163, 7242, 12013, 10173, 8482, 7126, 12061, 5168, 11589, 879, 2657, 6298, 751, 5172, 2876, 5176, 2345, 4009, 9400, 7216, 9281, 12182, 12214, 7468, 7380, 4727, 3010, 8441, 5046, 1550, 4522, 5975, 6701, 10955, 7058, 7909, 1621, 10717, 4642, 4421, 4237, 9513, 6728, 605, 6400, 9010, 7845, 9090, 8206, 7871, 2216, 9969, 8114, 722, 7656, 6890, 7252, 5058, 9900, 5743, 3217, 10420, 1260, 7068, 7460, 1552, 439, 10552, 10461, 8528, 1604, 5184, 4454, 11815, 7454, 9740, 7840, 9037, 11293, 11831, 97, 5970, 1513, 9144, 5127, 5916, 5266, 1366, 5936, 8552, 9376, 11918, 12257, 9407, 5447, 11271, 4355, 929, 2428, 6556, 2268, 7174, 8062, 945, 11670, 10868, 9577, 9563, 10594, 3922, 4070, 11510, 8088, 780, 7694, 6919, 4157, 4572, 10691, 3383, 3632, 11407, 1975, 5553, 11923, 6189, 5097, 1424, 4717, 2498, 5122, 8772, 1943, 7035, 869, 2996, 232, 10736, 7724, 2544, 2879, 1322, 5325, 10361, 7547, 1553, 1446, 6757, 8509, 3670, 11300, 714, 3282, 3998, 11675, 3500, 841, 3904, 4471, 892, 11868, 5586, 11095, 3193, 3584, 5530, 4766, 3212, 6160, 1032, 7770, 4884, 5372, 11890, 697, 11481, 1844, 11322, 3524, 6289, 1811, 9539, 5330, 285, 304, 2473, 6876, 12248, 730, 10467, 6697, 3359, 10650, 11663, 10772, 10826, 6810, 10564, 9029, 5526, 11950, 837, 5843, 5654, 5259, 352, 3278, 3933, 1351, 6615, 947, 2183, 6406, 1714, 10725, 7817, 1719, 4421, 1484, 4778, 2091, 6893, 6252, 11200, 7838, 2220, 24, 10134, 10311, 8294, 10568, 5895, 5809, 6993, 9476, 2476, 77, 3153, 10879, 11169, 8549, 296, 765, 2129, 81, 5775, 4614, 10605, 532, 3097, 7328, 6628, 9908, 8566, 8087, 11112, 6283, 11614, 9472, 5455, 4962, 5877, 6649, 4620, 10015, 4674, 5542, 7111, 6700, 1442, 9864, 6276, 4946, 12016, 3257, 3141, 3723, 3407, 7381, 8060, 5851, 198, 207, 4546, 127, 8900, 7841, 3061, 4437, 12190, 4847, 1416, 2019, 11119, 4664, 3511, 11777, 5986, 1440, 11743, 180, 10366, 730, 4873, 9449, 9980, 5180, 4856, 10099, 938, 5365, 6438, 970, 4982, 2298, 8345, 5506, 6849, 5176, 5880, 6134, 257, 3207, 11415, 2457, 1130, 9531, 474, 2131, 2561, 7841, 3296];
    // forgefmt: disable-next-line
	uint256[]  g_ntt_12289_512 = [4578, 8798, 568, 9048, 9364, 9312, 7618, 11615, 11012, 5944, 724, 4206, 4180, 26, 2558, 4689, 10937, 561, 4499, 3, 2563, 8778, 1784, 7772, 7283, 9221, 9231, 6652, 6230, 4181, 4567, 4280, 5386, 9420, 4198, 8527, 4503, 9523, 3233, 8086, 2815, 6427, 3641, 12079, 8922, 10365, 382, 10476, 1394, 3758, 8190, 6068, 3152, 5999, 3846, 6517, 9116, 38, 2008, 433, 7092, 3182, 4201, 11164, 11813, 11340, 1838, 8765, 6365, 9298, 3345, 445, 5109, 7773, 10995, 10098, 6973, 6286, 10237, 9505, 8066, 11245, 425, 3405, 9434, 11957, 8690, 6383, 2683, 4698, 72, 10951, 8931, 6649, 11633, 3259, 9010, 6804, 4036, 6539, 1554, 2811, 5834, 10626, 733, 2110, 180, 11331, 5215, 8831, 11742, 8026, 2716, 7974, 1539, 6008, 10506, 5743, 5905, 378, 8257, 9925, 299, 1105, 2300, 9789, 135, 2035, 5958, 4616, 1278, 1588, 6885, 1923, 11924, 11611, 1212, 11265, 5736, 10530, 9796, 5583, 11566, 9691, 11477, 3425, 4767, 3280, 154, 3413, 6967, 6996, 4594, 1915, 5663, 5698, 11434, 2809, 2067, 5697, 10724, 8436, 4906, 441, 1461, 8182, 4086, 11200, 5926, 5240, 11824, 6088, 727, 1644, 3901, 8251, 2924, 8963, 2537, 1767, 1378, 3590, 8189, 8032, 8825, 137, 9323, 1170, 2341, 4595, 1615, 4598, 11863, 2071, 7048, 6040, 11944, 2492, 255, 8464, 5352, 10480, 2267, 5905, 7359, 2092, 9809, 1402, 7560, 4525, 10741, 7558, 5815, 9208, 7045, 11145, 2085, 8376, 823, 8520, 2434, 6437, 1805, 10367, 586, 647, 438, 7623, 10520, 3608, 4785, 367, 5560, 6901, 4355, 1009, 10447, 10871, 632, 10230, 10355, 1020, 11206, 4958, 9380, 475, 7277, 8270, 6092, 8141, 5853, 479, 4573, 311, 2563, 4891, 4514, 9526, 9856, 2106, 10813, 2125, 9019, 1006, 1871, 1933, 1817, 2579, 1347, 7206, 2688, 3696, 5695, 11771, 130, 8906, 2391, 1552, 7749, 6787, 2750, 11803, 2394, 11649, 3543, 6094, 6991, 5930, 6716, 346, 10353, 4041, 10757, 3375, 11390, 9610, 4215, 6484, 2284, 4859, 4370, 5744, 124, 3449, 4656, 5833, 1789, 10278, 3631, 4109, 8250, 4875, 517, 9167, 11516, 1082, 7879, 10626, 2409, 8509, 1576, 9515, 1012, 617, 11909, 12123, 12244, 10648, 256, 8896, 8263, 8184, 8897, 9939, 10605, 10784, 11830, 11866, 2073, 3860, 1343, 4707, 7126, 4977, 9714, 1830, 5237, 8625, 7651, 9763, 11804, 1770, 4034, 10637, 9200, 9628, 3416, 7854, 580, 9830, 9580, 6330, 1922, 5990, 6317, 1979, 10509, 2852, 4061, 10599, 7252, 8027, 7479, 12001, 3566, 11967, 12093, 11655, 6979, 10043, 6032, 9008, 6613, 9594, 1860, 3150, 8244, 9082, 6656, 7058, 5085, 306, 1376, 1310, 169, 8400, 5648, 3916, 11614, 7199, 4397, 1451, 7246, 1440, 8539, 9262, 11818, 11049, 11646, 2087, 2458, 6822, 5927, 7697, 10614, 11304, 8047, 9164, 7664, 3357, 1896, 3299, 3213, 564, 11182, 5144, 5517, 2336, 593, 2455, 6818, 11921, 11398, 6601, 2144, 2534, 11668, 10983, 6318, 8775, 87, 958, 6472, 3843, 11925, 3260, 698, 1812, 1505, 6760, 10392, 6398, 1810, 4969, 6091, 155, 1062, 4664, 6514, 3374, 214, 6123, 6952, 8352, 8011, 12133, 11116, 2019, 10057, 9530, 8206, 5702, 9807, 11107, 65, 5853, 5880, 7128, 3488, 11886, 5546, 3874, 3323, 6773, 1667, 5754, 4510, 386, 1060, 9892, 3447, 8642, 7763, 9159, 11257, 3330, 10456, 9080, 10852, 10156, 2284, 4524, 7209, 755, 10899, 9144, 11517, 7132, 8475, 3352, 11672, 4760];
    // forgefmt: disable-next-line
	uint256[]  f_ntt_mul_g_ntt_12289_512 = [3664, 532, 2639, 7686, 1862, 11004, 112, 1471, 11310, 7865, 3791, 8834, 2212, 7682, 4875, 11677, 10047, 6689, 10127, 1328, 8820, 1567, 6427, 11365, 2007, 1978, 8689, 9574, 11285, 1734, 8247, 4650, 3359, 3491, 9450, 7577, 7672, 6057, 1210, 2098, 3294, 8900, 9946, 10089, 9545, 1531, 9749, 1370, 6211, 9252, 4978, 5090, 5717, 10282, 9307, 4033, 1532, 7437, 1939, 1912, 3424, 8089, 6769, 5079, 3418, 7695, 4140, 5086, 11387, 2445, 179, 3801, 11435, 2680, 2436, 1753, 8456, 5663, 2557, 5604, 806, 9821, 4577, 11798, 11199, 3025, 11521, 5385, 8615, 10757, 11529, 10508, 3546, 8358, 10584, 4970, 11235, 11250, 8395, 2203, 3199, 9641, 4420, 2407, 2551, 2877, 2993, 3615, 11393, 9388, 7211, 8942, 5712, 1293, 11256, 1318, 3094, 12272, 10230, 10167, 11732, 10632, 4554, 1630, 6398, 5251, 5100, 8970, 3936, 7575, 6262, 1339, 3211, 7566, 6837, 8322, 5490, 10983, 2282, 11767, 5815, 8813, 3206, 12257, 2986, 1866, 5794, 697, 7912, 11419, 5726, 10244, 4492, 525, 11794, 10166, 10466, 5600, 10779, 7801, 1035, 8710, 7553, 2945, 7425, 4031, 3170, 8152, 8041, 10673, 11427, 10247, 6089, 8365, 447, 4995, 5792, 7115, 7169, 1406, 6676, 7545, 1012, 12264, 1351, 5431, 353, 372, 8026, 8213, 2194, 5320, 11877, 7493, 5487, 12113, 2049, 11760, 645, 12183, 12063, 9228, 2021, 5608, 4329, 8528, 6912, 12264, 2704, 9020, 4674, 9264, 10185, 5528, 2316, 9097, 310, 6736, 10776, 1135, 2387, 11383, 2508, 4645, 2255, 4484, 7479, 7688, 9184, 10978, 10442, 8790, 921, 5477, 1823, 8725, 12248, 4532, 1699, 9470, 8845, 10704, 11788, 7205, 1234, 12149, 11752, 851, 9947, 5887, 11705, 758, 5269, 54, 7496, 6176, 9729, 2017, 2335, 6283, 4296, 4002, 4957, 6692, 7197, 6858, 7480, 8260, 7942, 8666, 10238, 5152, 2095, 5907, 7637, 2974, 4022, 3995, 113, 9392, 6477, 3512, 6698, 9650, 6614, 4171, 2335, 7144, 8283, 5222, 10018, 10334, 8785, 2654, 1801, 8100, 9930, 3780, 1, 7604, 6741, 9149, 11409, 6035, 4075, 7644, 95, 11962, 8850, 2967, 6918, 10069, 9122, 9462, 4158, 9665, 9156, 1949, 1570, 5967, 2663, 7183, 6318, 2457, 7766, 271, 8664, 8730, 3151, 8736, 78, 6101, 1290, 5785, 1700, 4481, 7229, 7623, 2477, 2200, 12180, 7131, 7833, 1884, 239, 6053, 583, 4094, 1845, 10725, 4273, 5513, 5141, 7831, 9831, 11802, 7136, 12073, 3946, 7200, 9601, 6013, 7523, 11268, 3284, 3045, 564, 5958, 2881, 6930, 516, 627, 6341, 8242, 9827, 4104, 4741, 12218, 7688, 494, 7415, 6539, 3143, 830, 11985, 2790, 321, 7672, 8997, 2759, 10496, 4392, 3443, 8742, 6042, 2673, 602, 9724, 5998, 12200, 1955, 10786, 4738, 4832, 2788, 2143, 985, 5487, 6087, 6666, 9487, 6082, 8454, 11590, 5088, 6651, 5169, 2653, 8080, 594, 12002, 5673, 145, 8723, 8645, 4087, 4919, 10945, 8251, 8533, 7519, 6407, 7763, 2477, 11038, 3709, 6159, 9031, 8955, 1970, 1579, 1804, 8539, 9344, 4373, 11169, 9570, 6260, 6520, 2743, 4139, 5685, 5868, 7542, 3941, 7584, 9057, 571, 5266, 11172, 10925, 8032, 1251, 7471, 9699, 257, 6968, 11081, 1550, 2783, 7278, 159, 2754, 6572, 8224, 2675, 245, 800, 8808, 11125, 2871, 9721, 4857, 8864, 9274, 10712, 411, 6488, 1221, 501, 10499, 4893, 9242, 1081, 241, 3421, 9060, 6580, 9222, 5029, 596, 7502, 3654, 3736, 1112, 9960, 3179, 1093, 7684, 6750, 3969, 8196];
    // forgefmt: disable-next-line
	uint256[]  f_mul_g_12289_512 = [4956, 10861, 9660, 5908, 3422, 8675, 8205, 10930, 10049, 809, 7684, 2034, 5282, 7376, 3142, 5230, 7405, 4868, 6071, 4971, 3320, 2313, 11926, 9039, 10594, 7102, 6081, 8559, 11342, 3415, 4642, 9260, 8524, 1018, 10699, 2240, 8688, 9744, 10176, 4205, 10672, 5295, 5531, 3684, 2743, 6127, 1490, 724, 5355, 8220, 2883, 6781, 2141, 3475, 4744, 1667, 2657, 8922, 4432, 10652, 8885, 6757, 7340, 10290, 2845, 11385, 3510, 10812, 8040, 5775, 2566, 1591, 8860, 927, 12197, 6076, 6583, 7247, 3237, 1602, 11412, 7534, 2829, 835, 6581, 7218, 4410, 4160, 8081, 1959, 6793, 5124, 81, 2088, 8654, 3136, 1269, 947, 8397, 3543, 5331, 6293, 9860, 470, 2231, 3040, 5327, 503, 10557, 1474, 7956, 2369, 1678, 3217, 3441, 3738, 8547, 4151, 5660, 11805, 3792, 6697, 8201, 5063, 776, 11682, 4362, 3286, 4680, 7569, 3837, 10192, 3966, 8037, 4823, 4364, 3513, 1647, 4187, 5508, 9154, 7195, 7053, 2079, 1465, 4147, 11746, 7167, 7621, 11122, 10302, 4600, 2239, 490, 9848, 6331, 7545, 7727, 7156, 605, 439, 2034, 11785, 6609, 8774, 9675, 10145, 3604, 3258, 5630, 6851, 8750, 11386, 5885, 1007, 9744, 4319, 6606, 6348, 2854, 9819, 9691, 6815, 2946, 2039, 9460, 11682, 56, 10770, 329, 1285, 10100, 3536, 10413, 1300, 2013, 1867, 79, 10254, 1951, 10057, 1494, 4712, 8306, 530, 3077, 7220, 2384, 8157, 2365, 8685, 10750, 5791, 10144, 1310, 5359, 5771, 4738, 9903, 7857, 4640, 701, 6425, 4896, 4130, 282, 7999, 4665, 4020, 1248, 5545, 4838, 431, 5767, 2993, 3036, 1979, 6049, 5725, 2966, 85, 11295, 9063, 9425, 6431, 8508, 9645, 8273, 8459, 10356, 4583, 6583, 876, 172, 10674, 10160, 9264, 3001, 5895, 782, 4312, 9365, 2945, 1835, 11322, 8026, 11683, 4676, 4770, 3188, 4468, 3087, 10164, 724, 6944, 9009, 802, 1402, 1521, 6871, 9965, 10646, 6961, 9853, 10765, 4573, 3572, 10258, 235, 3721, 9225, 7145, 2400, 882, 4251, 5240, 3462, 8958, 2775, 3578, 2002, 11844, 9420, 2729, 7328, 2002, 11362, 10203, 10582, 5290, 10766, 2324, 733, 2935, 3052, 10167, 11863, 11608, 5030, 630, 8535, 1802, 9617, 533, 9358, 4251, 7870, 7250, 6845, 6606, 2623, 10970, 5308, 3502, 10019, 3926, 837, 7676, 9937, 1384, 11118, 1989, 5582, 5026, 6571, 11135, 7777, 10479, 3552, 3636, 4625, 4155, 8367, 12052, 2823, 10270, 9593, 3157, 9593, 5625, 3423, 4122, 2610, 4467, 923, 9252, 7528, 979, 12180, 11511, 9923, 5689, 1751, 9949, 1092, 11024, 10682, 7839, 6404, 1085, 6475, 10834, 10886, 187, 3779, 2346, 5822, 934, 5058, 1790, 1084, 9176, 2947, 7806, 127, 10075, 9861, 3391, 7750, 8833, 6570, 6887, 4642, 9406, 6828, 4255, 9666, 7195, 10238, 6520, 3191, 3437, 2774, 4152, 10840, 7019, 11218, 10254, 5766, 5293, 10502, 4546, 11361, 10790, 3593, 8177, 9581, 9190, 2575, 3928, 12125, 451, 1746, 1259, 4540, 4798, 6782, 6978, 3006, 10691, 4418, 3349, 3976, 1583, 4491, 876, 10080, 8082, 1322, 7765, 2422, 5226, 7562, 7679, 7708, 10204, 1766, 4595, 11175, 5423, 11086, 5694, 1833, 5646, 8979, 7817, 1959, 3078, 9093, 7600, 4450, 2671, 114, 10196, 4177, 8619, 5742, 11290, 7540, 9904, 9290, 6651, 10771, 2267, 10186, 1211, 3354, 8521, 6418, 3075, 6469, 7628, 11860, 11511, 10350, 9758, 4878, 10023, 9322, 10939, 2945, 5503, 1151, 4470, 4522, 12029, 8427, 8350, 2127, 5752, 3776, 9217];

    function test_NWCntt() public view {
        console.log("length:", f_12289_512.length);
        uint256[] memory g = ntt.ZKNOX_NTTFW(f_12289_512, q);
        for (uint256 i = 0; i < 512; i++) {
            assertEq(f_ntt_12289_512[i], g[i]);
        }
    }

    function testbench_NWCntt() public view {
        uint256[] memory g = ntt.ZKNOX_NTTFW(f_12289_512, q);
        g[0] = 0; //warning removal
    }

    //test inverse NTT
    function test_NWCIntt() public view {
        console.log("length:", f_ntt_mul_g_ntt_12289_512.length);
        uint256[] memory g = ntt.ZKNOX_NTTINV(f_ntt_mul_g_ntt_12289_512, q);
        for (uint256 i = 0; i < 512; i++) {
            assertEq(f_mul_g_12289_512[i], g[i]);
        }
    }

    function testbench_NWCIntt() public view {
        uint256[] memory g = ntt.ZKNOX_NTTINV(f_12289_512, q);
        g[0] = 0; //warning removal
    }

    function test_mulNTTPoly() public view {
        uint256[] memory g = ntt.mul_NTTPoly(f_12289_512, g_12289_512, q);
        for (uint256 i = 0; i < 512; i++) {
            assertEq(f_mul_g_12289_512[i], g[i]);
        }
    }

    function test_mul_halfNTT_stateful() public view {
        uint256[] memory g = ntt.ZKNOX_NTT_HALFMUL(f_12289_512, g_ntt_12289_512);
        for (uint256 i = 0; i < 512; i++) {
            assertEq(f_mul_g_12289_512[i], g[i]);
        }
    }

    function testbench_halfNTT_stateless() public view {
        uint256 gasStart = gasleft();
        uint256[] memory g = ntt.ZKNOX_NTT_HALFMUL(f_12289_512, g_ntt_12289_512, q);
        uint256 gasUsed = gasStart - gasleft();

        console.log("Falcon ZKNOX_NTT_HALFMUL stateless gas cost :", gasUsed);

        g[0] = 0; //warning removal
    }

    function testbench_halfNTT_stateful() public view {
        uint256 gasStart = gasleft();
        uint256[] memory g = ntt.ZKNOX_NTT_HALFMUL(f_12289_512, g_ntt_12289_512);
        uint256 gasUsed = gasStart - gasleft();

        console.log("Falcon ZKNOX_NTT_HALFMUL stateful gas cost :", gasUsed);

        g[0] = 0; //warning removal
    }

    //exemple of stateful initialisation, no external contract provided
    function setUp() public {
        bytes memory bytecode_psirev = abi.encodePacked(psi_rev);

        address a_psirev; //address of the precomputations bytecode contract
        a_psirev = address(uint160(0xcaca)); //here it is etched, use create in the future
        vm.etch(a_psirev, bytecode_psirev); //pushing psirev bytecode into contract todo : replace with create

        bytes memory bytecode_psiInvrev = abi.encodePacked(psi_inv_rev);

        address a_psiInvrev; //address of the precomputations bytecode contract
        a_psiInvrev = address(uint160(0xa5a5)); //here it is etched, use create in the future
        vm.etch(a_psiInvrev, bytecode_psiInvrev); //pushing psirev bytecode into contract todo : replace with create

        ntt.update(a_psirev, a_psiInvrev, 12289, 12265); //update ntt with outer contract

        uint256[] memory g = ntt.ZKNOX_NTTFW(f_12289_512, a_psirev);
        for (uint256 i = 0; i < 512; i++) {
            assertEq(f_ntt_12289_512[i], g[i]);
        }

        g = ntt.ZKNOX_NTTINV(f_ntt_mul_g_ntt_12289_512, ntt.o_psi_inv_rev());
        for (uint256 i = 0; i < 512; i++) {
            assertEq(f_mul_g_12289_512[i], g[i]);
        }
    }

    function testbench_nttfwOuter() public view {
        uint256[] memory g = ntt.ZKNOX_NTTFW(f_12289_512, ntt.o_psirev());
        g[0] = 0; //warning removal
    }

    function testbench_nttinvOuter() public view {
        uint256[] memory g = ntt.ZKNOX_NTTINV(f_12289_512, ntt.o_psi_inv_rev());
        g[0] = 0; //warning removal
    }

    function _ZKNOX_NTT_Compact(uint256[] memory a) internal pure returns (uint256[] memory b) {
        b = new uint256[](32);
        for (uint256 i = 0; i < a.length; i++) {
            b[i >> 4] ^= a[i] << ((i & 0xf) << 4);
        }

        return b;
    }

    function ZKNOX_NTT_Expand(uint256[] memory a) internal pure returns (uint256[] memory b) {
        b = new uint256[](512);

        for (uint256 i = 0; i < 32; i++) {
            for (uint256 j = 0; j < 16; j++) {
                b[(i << 4) + j] = (a[i] >> (j << 4)) & 0xffff;
            }
        }

        return b;
    }

    function test_Compact() public view {
        uint256[] memory f_12289_512c = _ZKNOX_NTT_Compact(f_12289_512);
        uint256[] memory g_12289_512c = _ZKNOX_NTT_Compact(g_ntt_12289_512);

        uint256 gasStart = gasleft();
        uint256[] memory involutino = ntt.ZKNOX_NTT_HALFMUL_Compact(f_12289_512c, g_12289_512c);
        uint256 gasUsed = gasStart - gasleft();

        console.log("Falcon ZKNOX_NTT_HALFMUL_Compact gas cost:", gasUsed);

        uint256[] memory res = ZKNOX_NTT_Expand(involutino);
        for (uint256 i = 0; i < 512; i++) {
            assertEq(res[i], f_mul_g_12289_512[i]);
        }
    }
}
